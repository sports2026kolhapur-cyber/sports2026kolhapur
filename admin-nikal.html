<!doctype html>
<html lang="mr">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Panel ‚Äì ‡§®‡§ø‡§ï‡§æ‡§≤ ‡§≠‡§∞‡§£‡•á</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      :root {
        --primary: #1e40af;
        --bg: #f1f5f9;
        --card: #ffffff;
      }
      body {
        margin: 0;
        padding: 16px;
        background: var(--bg);
        font-family: "Noto Sans Devanagari", "Mukta", system-ui, sans-serif;
      }
      .container {
        max-width: 720px;
        margin: auto;
      }
      .card {
        background: var(--card);
        padding: 24px;
        border-radius: 14px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
      }
      h1,
      h2 {
        text-align: center;
        color: var(--primary);
      }
      label {
        font-weight: 700;
        margin-top: 14px;
        display: block;
      }
      select,
      input {
        width: 100%;
        padding: 12px;
        margin-top: 6px;
        border-radius: 10px;
        border: 1.8px solid #cbd5e1;
        font-size: 15px;
      }
      button {
        width: 100%;
        margin-top: 20px;
        padding: 14px;
        border: none;
        border-radius: 12px;
        background: var(--primary);
        color: #fff;
        font-size: 16px;
        font-weight: 800;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .logout {
        background: #7c2d12;
      }
      .success {
        margin-top: 12px;
        color: #065f46;
        font-weight: 800;
        display: none;
        text-align: center;
      }
      .error {
        margin-top: 12px;
        color: #dc2626;
        font-weight: 800;
        display: none;
        text-align: center;
      }

      /* table */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 18px;
      }
      th,
      td {
        border: 1px solid #cbd5e1;
        padding: 8px;
        text-align: center;
      }
      th {
        background: #e5e7eb;
      }
      .action-btn {
        padding: 6px 10px;
        margin: 2px;
        font-size: 14px;
        border-radius: 8px;
      }
      .edit {
        background: #0ea5e9;
        color: #fff;
      }
      .delete {
        background: #dc2626;
        color: #fff;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="card">
        <h1>üèÜ ‡§®‡§ø‡§ï‡§æ‡§≤ ‡§≠‡§∞‡§£‡•á (Admin)</h1>

        <label>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</label>
        <select id="main">
          <option value="">‚Äî ‡§®‡§ø‡§µ‡§°‡§æ ‚Äî</option>
          <option value="sports">‡§ï‡•ç‡§∞‡•Ä‡§°‡§æ</option>
          <option value="cultural">‡§∏‡§æ‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§ø‡§ï</option>
        </select>

        <label>‡§∏‡§π‡§≠‡§æ‡§ó ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</label>
        <select id="type">
          <option value="">‚Äî ‡§®‡§ø‡§µ‡§°‡§æ ‚Äî</option>
          <option value="individual">‡§µ‡•à‡§Ø‡§ï‡•ç‡§§‡§ø‡§ï</option>
          <option value="duheri">‡§¶‡•Å‡§π‡•á‡§∞‡•Ä</option>
          <option value="team">‡§∏‡§æ‡§Ç‡§ò‡§ø‡§ï</option>
        </select>

        <label>‡§ñ‡•á‡§≥ / ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ</label>
        <select id="program">
          <option value="">‚Äî ‡§®‡§ø‡§µ‡§°‡§æ ‚Äî</option>
        </select>

        <label>‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï</label>
        <select id="position">
          <option value="">‚Äî ‡§®‡§ø‡§µ‡§°‡§æ ‚Äî</option>
          <option value="‡§™‡•ç‡§∞‡§•‡§Æ">‡§™‡•ç‡§∞‡§•‡§Æ</option>
          <option value="‡§¶‡•ç‡§µ‡§ø‡§§‡•Ä‡§Ø">‡§¶‡•ç‡§µ‡§ø‡§§‡•Ä‡§Ø</option>
          <option value="‡§§‡•É‡§§‡•Ä‡§Ø">‡§§‡•É‡§§‡•Ä‡§Ø</option>
        </select>

        <label>‡§µ‡§ø‡§ú‡•á‡§§‡§æ ‡§®‡§æ‡§µ ( / ‡§µ‡§æ‡§™‡§∞‡•Ç ‡§∂‡§ï‡§§‡§æ )</label>
        <input id="name" placeholder="‡§®‡§æ‡§µ1 / ‡§®‡§æ‡§µ2 / ‡§®‡§æ‡§µ3" />

        <label>‡§Æ‡§Ç‡§°‡§≥ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø</label>
        <select id="office">
          <option value="">‚Äî ‡§®‡§ø‡§µ‡§°‡§æ ‚Äî</option>

          <option value="‡§Ø‡§æ‡§Ç‡§§‡•ç‡§∞‡§ø‡§ï‡•Ä ‡§Æ‡§Ç‡§°‡§≥, ‡§ï‡•ã‡§≤‡•ç‡§π‡§æ‡§™‡•Ç‡§∞">
            ‡§Ø‡§æ‡§Ç‡§§‡•ç‡§∞‡§ø‡§ï‡•Ä ‡§Æ‡§Ç‡§°‡§≥, ‡§ï‡•ã‡§≤‡•ç‡§π‡§æ‡§™‡•Ç‡§∞
          </option>

          <option value="‡§Ø‡§æ‡§Ç‡§§‡•ç‡§∞‡§ø‡§ï‡•Ä ‡§Æ‡§Ç‡§°‡§≥, ‡§™‡•Å‡§£‡•á">‡§Ø‡§æ‡§Ç‡§§‡•ç‡§∞‡§ø‡§ï‡•Ä ‡§Æ‡§Ç‡§°‡§≥, ‡§™‡•Å‡§£‡•á</option>

          <option value="‡§Ø‡§æ‡§Ç‡§§‡•ç‡§∞‡§ø‡§ï‡•Ä ‡§Æ‡§Ç‡§°‡§≥, ‡§®‡§æ‡§∂‡§ø‡§ï">‡§Ø‡§æ‡§Ç‡§§‡•ç‡§∞‡§ø‡§ï‡•Ä ‡§Æ‡§Ç‡§°‡§≥, ‡§®‡§æ‡§∂‡§ø‡§ï</option>

          <option value="‡§Ø‡§æ‡§Ç‡§§‡•ç‡§∞‡§ø‡§ï‡•Ä ‡§Æ‡§Ç‡§°‡§≥, ‡§®‡§æ‡§Ç‡§¶‡•á‡§°">‡§Ø‡§æ‡§Ç‡§§‡•ç‡§∞‡§ø‡§ï‡•Ä ‡§Æ‡§Ç‡§°‡§≥, ‡§®‡§æ‡§Ç‡§¶‡•á‡§°</option>

          <option value="‡§Ø‡§æ‡§Ç‡§§‡•ç‡§∞‡§ø‡§ï‡•Ä ‡§Æ‡§Ç‡§°‡§≥, ‡§®‡§æ‡§ó‡§™‡•Ç‡§∞">‡§Ø‡§æ‡§Ç‡§§‡•ç‡§∞‡§ø‡§ï‡•Ä ‡§Æ‡§Ç‡§°‡§≥, ‡§®‡§æ‡§ó‡§™‡•Ç‡§∞</option>

          <option value="‡§™‡§æ‡§ü‡§¨‡§Ç‡§ß‡§æ‡§∞‡•á ‡§∏‡§Ç‡§∂‡•ã‡§ß‡§® ‡§µ ‡§µ‡§ø‡§ï‡§æ‡§∏ ‡§∏‡§Ç‡§ö‡§æ‡§≤‡§®‡§æ‡§≤‡§Ø, ‡§™‡•Å‡§£‡•á">
            ‡§™‡§æ‡§ü‡§¨‡§Ç‡§ß‡§æ‡§∞‡•á ‡§∏‡§Ç‡§∂‡•ã‡§ß‡§® ‡§µ ‡§µ‡§ø‡§ï‡§æ‡§∏ ‡§∏‡§Ç‡§ö‡§æ‡§≤‡§®‡§æ‡§≤‡§Ø, ‡§™‡•Å‡§£‡•á
          </option>
        </select>

        <button id="saveBtn" onclick="save()">‡§®‡§ø‡§ï‡§æ‡§≤ Save / Update ‡§ï‡§∞‡§æ</button>

        <div id="success" class="success">‚úÖ ‡§®‡§ø‡§ï‡§æ‡§≤ ‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä‡§∞‡•Ä‡§§‡•ç‡§Ø‡§æ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡§æ</div>
        <div id="error" class="error"></div>

        <button class="logout" onclick="logout()">Logout</button>

        <hr style="margin: 28px 0" />

        <h2>üìã ‡§∏‡§ß‡•ç‡§Ø‡§æ‡§ö‡•á ‡§®‡§ø‡§ï‡§æ‡§≤</h2>

        <table>
          <thead>
            <tr>
              <th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ</th>
              <th>‡§∏‡§π‡§≠‡§æ‡§ó</th>
              <th>‡§ñ‡•á‡§≥</th>
              <th>‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï</th>
              <th>‡§µ‡§ø‡§ú‡•á‡§§‡§æ</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="resultBody"></tbody>
        </table>
      </div>
    </div>

    <script>
      const API =
        "https://script.google.com/macros/s/AKfycby4jBFfFt6GSBlQj_Cs22HrFA-0oXMZNQd0tBHA7h_FHYR2FLqR4UFaiCAfruYJQd9-NA/exec";

      const ADMIN_TOKEN = sessionStorage.getItem("adminToken");

      /* üîê login guard */
      if (sessionStorage.getItem("adminLogged") !== "1") {
        location.href = "admin-login.html";
      }

      /* üîó elements */
      const mainEl = document.getElementById("main");
      const typeEl = document.getElementById("type");
      const programEl = document.getElementById("program");
      const positionEl = document.getElementById("position");
      const nameEl = document.getElementById("name");
      const officeEl = document.getElementById("office");
      const successEl = document.getElementById("success");
      const errorEl = document.getElementById("error");
      const resultBody = document.getElementById("resultBody");
      const saveBtn = document.getElementById("saveBtn");

      let editRow = null;
      if (!ADMIN_TOKEN) {
        alert("‚õî Admin session expired");
        location.href = "admin-login.html";
      }

      /* üîÅ load programs from ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä sheet */
      mainEl.addEventListener("change", loadPrograms);
      typeEl.addEventListener("change", loadPrograms);

      async function loadPrograms() {
        programEl.innerHTML = `<option value="">‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</option>`;
        programEl.disabled = true;

        if (!mainEl.value || !typeEl.value) {
          programEl.innerHTML = `<option value="">‚Äî ‡§®‡§ø‡§µ‡§°‡§æ ‚Äî</option>`;
          return;
        }

        try {
          const res = await fetch(
            `${API}?action=velapatrakPrograms` +
              `&main=${encodeURIComponent(mainEl.value)}` +
              `&type=${encodeURIComponent(typeEl.value)}` +
              `&adminToken=${encodeURIComponent(ADMIN_TOKEN)}`,
          );

          const list = await res.json();

          programEl.innerHTML = `<option value="">‚Äî ‡§®‡§ø‡§µ‡§°‡§æ ‚Äî</option>`;

          if (list.length === 0) {
            programEl.innerHTML = `<option value="">‚õî ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä‡§§</option>`;
            return;
          }

          list.forEach((p) => {
            const opt = document.createElement("option");
            opt.value = p;
            opt.textContent = p;
            programEl.appendChild(opt);
          });

          programEl.disabled = false;
        } catch (e) {
          console.error(e);
          programEl.innerHTML = `<option value="">‚ùå Server Error</option>`;
        }
      }

      /* üíæ save / update - FIXED VERSION */
      async function save() {
        successEl.style.display = "none";
        errorEl.style.display = "none";

        if (
          !mainEl.value ||
          !typeEl.value ||
          !programEl.value ||
          !positionEl.value ||
          !nameEl.value
        ) {
          errorEl.textContent = "‚ùå ‡§∏‡§∞‡•ç‡§µ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§≠‡§∞‡§æ";
          errorEl.style.display = "block";
          return;
        }

        saveBtn.disabled = true;
        saveBtn.textContent = "Saving...";

        try {
          // Delete old row if editing
          if (editRow) {
            console.log("Deleting old row:", editRow);
            await fetch(
              `${API}?action=deleteResult` +
                `&adminToken=${encodeURIComponent(ADMIN_TOKEN)}` +
                `&row=${editRow}`,
            );
            editRow = null;
          }

          const params = new URLSearchParams({
            action: "saveResult",
            adminToken: ADMIN_TOKEN,
            main: mainEl.value,
            type: typeEl.value,
            program: programEl.value,
            position: positionEl.value,
            name: nameEl.value,
            office: officeEl.value,
          });

          console.log("Saving with params:", params.toString());

          const res = await fetch(`${API}?${params.toString()}`);

          // Check if response is OK
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }

          const data = await res.json();
          console.log("Response:", data);

          if (!data.ok) {
            throw new Error(data.message || "Save failed");
          }

          successEl.style.display = "block";
          clearForm();
          await loadResults();
        } catch (error) {
          console.error("Save error:", error);
          errorEl.textContent = "‚ùå Error: " + error.message;
          errorEl.style.display = "block";
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = "‡§®‡§ø‡§ï‡§æ‡§≤ Save / Update ‡§ï‡§∞‡§æ";
        }
      }

      /* üìã load results */
      async function loadResults() {
        try {
          const res = await fetch(
            `${API}?action=adminResultList` +
              `&adminToken=${encodeURIComponent(ADMIN_TOKEN)}`,
          );
          const list = await res.json();

          resultBody.innerHTML = "";
          list.forEach((r) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
      <td>${r.main}</td>
      <td>${r.type}</td>
      <td>${r.program}</td>
      <td>${r.position}</td>
      <td>${r.name}</td>
      <td>
        <button class="action-btn edit" onclick='editResult(${JSON.stringify(r)})'>‚úèÔ∏è</button>
        <button class="action-btn delete" onclick='deleteResult(${r.row})'>üóëÔ∏è</button>
      </td>`;
            resultBody.appendChild(tr);
          });
        } catch (error) {
          console.error("Load results error:", error);
        }
      }

      /* ‚úèÔ∏è edit */
      async function editResult(r) {
        editRow = r.row;

        mainEl.value = r.main;
        typeEl.value = r.type;

        await loadPrograms();

        programEl.value = r.program;
        positionEl.value = r.position;
        nameEl.value = r.name;
        officeEl.value = r.office;

        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      /* üóëÔ∏è delete */
      async function deleteResult(row) {
        if (!confirm("‡§π‡§æ ‡§®‡§ø‡§ï‡§æ‡§≤ delete ‡§ï‡§∞‡§æ‡§Ø‡§ö‡§æ ‡§Ü‡§π‡•á ‡§ï‡§æ?")) return;

        try {
          await fetch(
            `${API}?action=deleteResult` +
              `&adminToken=${encodeURIComponent(ADMIN_TOKEN)}` +
              `&row=${row}`,
          );
          await loadResults();
        } catch (error) {
          console.error("Delete error:", error);
          alert("‚ùå Delete ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§Ö‡§°‡§ö‡§£ ‡§Ü‡§≤‡•Ä");
        }
      }

      /* utils */
      function clearForm() {
        mainEl.value = "";
        typeEl.value = "";
        programEl.innerHTML = `<option value="">‚Äî ‡§®‡§ø‡§µ‡§°‡§æ ‚Äî</option>`;
        positionEl.value = "";
        nameEl.value = "";
        officeEl.value = "";
      }

      function logout() {
        sessionStorage.removeItem("adminLogged");
        sessionStorage.removeItem("adminToken");
        location.href = "dashboard.html";
      }

      /* init */
      window.addEventListener("DOMContentLoaded", () => {
        loadResults();
      });
    </script>
  </body>
</html>
